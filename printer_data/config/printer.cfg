# This file contains common pin mappings for the BigTreeTech SKR 3.
# To use this config, the firmware should be compiled for the
# STM32H743 with a "128KiB bootloader".

# See docs/Config_Reference.md for a description of parameters.

# Include supporting configuration files
[include mainsail.cfg]
[include led_effects.cfg]
[include screws_tilt_adjust.cfg]
#[include nebula.cfg]
[include moonraker_obico_macros.cfg]
[include wipe_nozzle_pause.cfg]
[include macros.cfg] # General custom macros
[include sample-bigtreetech-adxl345-v2.0.cfg] # ADXL Config (Bed)
[include knomi.cfg]
[include bigtreetech-eddy-zoffbeta.cfg] # WARNING: Keeping this active WILL likely cause SAVE_CONFIG z_offset conflicts.
[include sample-bigtreetech-ebb-sb-usb-v1.0.cfg] # EBB Toolhead board config
[include ebbfan.cfg] # EBB Fan definitions
[include skr3fan.cfg] # SKR3 Fan definitions
[exclude_object]
[include WIPE_NOZZLE.cfg]

# BTT CB2 / host CPU temperature (if CB2 is used as host)
[temperature_sensor CB2_CPU]
sensor_type: temperature_host
min_temp: 0
max_temp: 90

# Main Controller Board MCU
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_070026001351333031373138-if00

# Eddy USB MCU
[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_504450611083D51C-if00
restart_method: command

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu
sensor_mcu: eddy
min_temp: 10
max_temp: 120

######################################################################
## Steppers & Drivers
######################################################################

[stepper_x]
step_pin: PD4
dir_pin: !PD3
enable_pin: !PD6
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: -2
position_endstop: 0
position_max: 430
homing_speed: 50
homing_retract_dist: 0
homing_positive_dir: false

[tmc2209 stepper_x]
uart_pin: PD5
diag_pin: ^PC1
driver_SGTHRS: 90
run_current: 0.8
hold_current: 0.6
sense_resistor: 0.220
interpolate: True
stealthchop_threshold: 0

[stepper_y]
step_pin: PA15
dir_pin: !PA8
enable_pin: !PD1
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: -2
position_endstop: 0
position_max: 435
homing_speed: 50
homing_retract_dist: 0
homing_positive_dir: false

[tmc2209 stepper_y]
uart_pin: PD0
diag_pin: ^PC3
driver_SGTHRS: 80
run_current: 0.6
hold_current: 0.35
sense_resistor: 0.220
interpolate: True
stealthchop_threshold: 0

[stepper_z]
step_pin: PE2
dir_pin: PE3
enable_pin: !PE0
microsteps: 16
rotation_distance: 8
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop # Using Eddy probe for Z homing
position_min: -5
position_max: 395
homing_speed: 5
second_homing_speed: 3
homing_retract_dist: 7

[tmc2209 stepper_z]
uart_pin: PE1
# diag_pin: PC0 # Diag pin should remain removed if using probe for homing
run_current: 0.85
hold_current: 0.5
sense_resistor: 0.220
interpolate: True
stealthchop_threshold: 0

######################################################################
## Heaters, Fans & Sensors
######################################################################

[heater_bed]
heater_pin: PD7
sensor_type: Generic 3950
sensor_pin: PA1
control: pid
min_temp: 10
max_temp: 115
# IMPORTANT: Ensure these PID values are uncommented
pid_kp: 62.465
pid_ki: 1.482
pid_kd: 658.225
#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# pid_kp = 62.465
#*# pid_ki = 1.482
#*# pid_kd = 658.225

[controller_fan motherboard_fan]
pin: PB7
stepper: stepper_x, stepper_y, stepper_z, extruder
heater: heater_bed
idle_timeout: 60

[filament_switch_sensor filament_sensor]
switch_pin: ^PC15
pause_on_runout: True
insert_gcode:
    M117 Insert Detected

# Chamber thermistor on SKR 3 EZ TH1
[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PA3 # TH1 on SKR 3 EZ (verify silkscreen)
pullup_resistor: 4700 # SKR boards use 4.7k pull-ups
min_temp: -20
max_temp: 120

######################################################################
## Eddy Probe (BTT Eddy USB)
######################################################################

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
i2c_mcu: eddy
i2c_bus: i2c0f
# IMPORTANT: z_offset MUST be defined here for Klipper to start.
# This value (2.781) is taken from your SAVE_CONFIG block below.
# Because you are including bigtreetech-eddy-zoffbeta.cfg, SAVE_CONFIG
# commands will likely fail. If you run PROBE_CALIBRATE, you MUST
# manually update the value on the line below.
z_offset: 2.781
x_offset: 0
y_offset: 20
# --- Auto-generated SAVE_CONFIG data follows ---
#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# z_offset = 2.781
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3258925.860,0.090000:3258001.095,0.130000:3257008.336,
#*# 	0.170000:3256036.591,0.210000:3255063.220,0.250000:3254110.932,
#*# 	0.290000:3253143.586,0.330000:3252171.671,0.370000:3251215.305,
#*# 	0.410000:3250254.482,0.450000:3249298.389,0.490000:3248393.601,
#*# 	0.530000:3247507.244,0.570000:3246624.702,0.610000:3245735.391,
#*# 	0.650000:3244846.467,0.690000:3243988.663,0.730000:3243127.154,
#*# 	0.770000:3242261.222,0.810000:3241439.461,0.850000:3240642.821,
#*# 	0.890000:3239820.080,0.930000:3239054.538,0.970000:3238259.023,
#*# 	1.010000:3237510.819,1.050000:3236718.212,1.090000:3235991.657,
#*# 	1.130000:3235234.528,1.170000:3234547.716,1.210000:3233793.238,
#*# 	1.250000:3233097.473,1.290000:3232403.582,1.330000:3231748.834,
#*# 	1.370000:3231067.704,1.410000:3230384.857,1.450000:3229777.806,
#*# 	1.490000:3229169.236,1.530000:3228559.633,1.570000:3227942.677,
#*# 	1.610000:3227366.080,1.650000:3226797.112,1.690000:3226263.497,
#*# 	1.730000:3225693.962,1.770000:3225170.461,1.810000:3224656.820,
#*# 	1.850000:3224147.780,1.890000:3223640.999,1.930000:3223142.184,
#*# 	1.970000:3222670.680,2.010000:3222214.394,2.050000:3221735.410,
#*# 	2.090000:3221260.040,2.130000:3220820.866,2.170000:3220386.313,
#*# 	2.210000:3219972.096,2.250000:3219532.237,2.290000:3219138.261,
#*# 	2.330000:3218728.576,2.370000:3218327.379,2.410000:3217915.728,
#*# 	2.450000:3217583.148,2.490000:3217193.371,2.530000:3216836.260,
#*# 	2.570000:3216478.259,2.610000:3216141.067,2.650000:3215770.971,
#*# 	2.690000:3215461.052,2.730000:3215112.323,2.770000:3214803.776,
#*# 	2.810000:3214480.090,2.850000:3214177.900,2.890000:3213840.146,
#*# 	2.930000:3213547.792,2.970000:3213230.917,3.010000:3212952.644,
#*# 	3.050000:3212635.964,3.090000:3212370.808,3.130000:3212054.363,
#*# 	3.170000:3211787.261,3.210000:3211504.916,3.250000:3211222.138,
#*# 	3.290000:3210967.307,3.330000:3210684.430,3.370000:3210440.196,
#*# 	3.410000:3210194.065,3.450000:3209928.351,3.490000:3209692.776,
#*# 	3.530000:3209440.178,3.570000:3209216.505,3.610000:3208987.091,
#*# 	3.650000:3208787.670,3.690000:3208560.099,3.730000:3208336.671,
#*# 	3.770000:3208109.334,3.810000:3207900.678,3.850000:3207676.656,
#*# 	3.890000:3207484.989,3.930000:3207290.124,3.970000:3207081.245,
#*# 	4.010000:3206896.173,4.050000:3206697.617
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 50.868003
#*# drift_calibration =
#*# 	3274238.528382, -1050.979270, 9.719414
#*# 	3250513.025280, -451.839830, 3.800633
#*# 	3238539.712094, -318.721378, 2.615138
#*# 	3229404.470212, -233.890181, 1.753721
#*# 	3220500.820526, -98.066528, 0.423859
#*# 	3213820.260864, -1.221144, -0.511388
#*# 	3209302.907959, 43.301258, -0.921270
#*# 	3205573.811628, 80.046592, -1.267420
#*# 	3201702.289020, 140.510842, -1.837133
#*# drift_calibration_min_temp = 33.55159907837751
#*#
#*# [input_shaper]
#*#
#*# [heater_bed]
#*# pid_kp = 62.465
#*# pid_ki = 1.482
#*# pid_kd = 658.225
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.200123, -0.218205, -0.264081, 0.002715, 0.059187, 0.110825, 0.171465, -0.145347, -0.083750, 0.016415
#*# 	-0.009191, 0.022377, -0.018870, -0.014405, 0.027757, 0.064746, 0.094801, 0.144629, 0.222331, 0.339537
#*# 	-0.069198, -0.015787, -0.056986, -0.064640, -0.040944, -0.019833, 0.002723, 0.031505, 0.087114, 0.121150
#*# 	-0.059897, 0.004573, -0.026524, -0.032530, -0.003360, 0.007992, 0.018087, 0.038048, 0.065813, 0.064613
#*# 	-0.009535, 0.063323, 0.031035, 0.017896, 0.020812, 0.041331, 0.028361, 0.030470, 0.055275, 0.056767
#*# 	0.005806, 0.080730, 0.061391, 0.056341, 0.072947, 0.081408, 0.083686, 0.078545, 0.093029, 0.090803
#*# 	-0.019265, 0.062773, 0.048272, 0.046180, 0.066819, 0.078813, 0.074834, 0.075177, 0.106957, 0.112396
#*# 	-0.014927, 0.070055, 0.067442, 0.075385, 0.149475, 0.139059, 0.139216, 0.145906, 0.164663, 0.155403
#*# 	0.051200, 0.113302, 0.093772, 0.082998, 0.105941, 0.109202, 0.105325, 0.113387, 0.138082, 0.157033
#*# 	0.089861, 0.145589, 0.093227, 0.076946, 0.094429, 0.110245, 0.130239, 0.140683, 0.189768, 0.152736
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 404.96999999999997
#*# min_y = 30.0
#*# max_y = 390.0
#*#
#*# [bed_mesh current]
#*# version = 1
#*# points =
#*# 	  0.059741, 0.076003, 0.110550, 0.161124, 0.195164, 0.176978, 0.143736, 0.069265, 0.045711
#*# 	  0.123547, 0.154094, 0.201430, 0.272613, 0.297661, 0.261910, 0.216225, 0.160908, 0.121479
#*# 	  0.142525, 0.163205, 0.203527, 0.255988, 0.281239, 0.233776, 0.187198, 0.149170, 0.130155
#*# 	  0.165707, 0.174000, 0.199591, 0.241204, 0.245244, 0.230425, 0.185338, 0.168098, 0.149158
#*# 	  0.119922, 0.106535, 0.096949, 0.110952, 0.094258, 0.094788, 0.096269, 0.109795, 0.121881
#*# 	  0.061389, 0.039965, 0.019211, 0.015359, 0.010998, 0.030034, 0.044997, 0.081857, 0.113621
#*# 	  0.045423, -0.002846, -0.038450, -0.032787, -0.067928, -0.045252, -0.009139, 0.050726, 0.101719
#*# 	  0.086736, 0.028359, -0.030797, -0.045621, -0.051719, -0.032948, 0.004819, 0.037969, 0.092797
#*# 	  0.118067, 0.025684, -0.038487, -0.068483, -0.075194, -0.052711, -0.018228, 0.054700, 0.106596
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 61.16759999999999
#*# max_x = 374.0476
#*# min_y = 95.614
#*# max_y = 384.01400000000007
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.394
#*# pid_ki = 3.431
#*# pid_kd = 71.813

######################################################################
## Printer & Kinematics
######################################################################

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 2000
max_z_velocity: 40
max_z_accel: 160
square_corner_velocity: 7

######################################################################
## Input Shaping (from previous calibration)
######################################################################

[input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 38.4
#*# shaper_type_y = ei
#*# shaper_freq_y = 33.0

######################################################################
## Shake&Tune Configuration (ADDED)
######################################################################
[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
#   Path where the processed results will be stored. If the folder doesn't exist,
#   it will be automatically created. You can change this if you'd like to store
#   results in a different location.
number_of_results_to_keep: 10
#   This setting defines how many results you want to keep in the result folder.
#   Once the specified number is exceeded, older results will be automatically deleted
#   to free up space on the SD card and avoid cluttering the results folder.
keep_raw_data: False
#   If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#   .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#   Please always attach them when reporting any issues on GitHub or Discord.
show_macros_in_webui: True
#   Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#   of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#   If set to False, the macros will be hidden but still accessible from the console by typing
#   their names manually, which can be useful if you prefer to encapsulate them into your own macros.
timeout: 600
#   This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating
#   graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#   slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
measurements_chunk_size: 2
#   Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#   Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#   command will merge these chunks into the final .stdata file for processing. "2" is a very
#   conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#   RAM, and should work for everyone. However, if you are using a powerful computer, you may
#   wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#   the chunk and avoid stressing the filesystem too much.
max_freq: 200
#   This setting defines the maximum frequency at which the calculation of the power spectral density
#   is cutoff. The default value should be fine for most machines and accelerometer combinations and
#   avoid touching it unless you know what you're doing.
dpi: 300
#   Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#   and strikes a balance between performance and readability, ensuring that graphs are clear
#   without using too much RAM to generate them. Usually, you shouldn't need to change this value.

######################################################################
## Board Pins Aliases (SKR 3)
######################################################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC5, EXP1_3=PB1, EXP1_5=PE9,  EXP1_7=PE11, EXP1_9=<GND>,
    EXP1_2=PB0, EXP1_4=PE8, EXP1_6=PE10, EXP1_8=PE12, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=PA6, EXP2_3=PE7, EXP2_5=PB2, EXP2_7=PC4,   EXP2_9=<GND>,
    EXP2_2=PA5, EXP2_4=PA4, EXP2_6=PA7, EXP2_8=<RST>, EXP2_10=<NC>

######################################################################
## Custom GCode Macros (Examples)
######################################################################

[gcode_macro BED_STEP_RAMP]
description: Ramp bed to TARGET in fixed steps (default 10C) and hold at each step (default 70s) to avoid warping/overshoot.
# Tunables (can be overridden at call time)
variable_step_c: 10        # C per step
variable_hold_s: 70        # seconds to hold at each step
variable_tol_c: 1.0        # ±C window used by TEMPERATURE_WAIT
gcode:
  {% set target = params.TARGET|default(110)|float %}
  {% set step   = params.STEP|default(step_c)|int %}
  {% set hold   = params.HOLD_S|default(hold_s)|int %}
  {% set tol    = params.TOL|default(tol_c)|float %}

  {% if target < 1.0 %}{% set target = 1.0 %}{% endif %}
  {% if step   < 1 %}{% set step   = 1 %}{% endif %}
  {% if hold   < 1 %}{% set hold   = 1 %}{% endif %}

  {% set start = printer.heater_bed.temperature|float %}
  # Next multiple of STEP above current temp
  {% set first_stop = ((start / step)|int * step) + step %}
  {% if first_stop > target %}{% set first_stop = target %}{% endif %}

  {% set msg0 = "BED_STEP_RAMP: %.1f->%.0fC, step=%dC, hold=%ds" % (start, target, step, hold) %}
  RESPOND TYPE=echo MSG="{msg0}"

  # Step through: first_stop, first_stop+step, ..., < target
  {% for sp in range(first_stop|int, (target|int), step) %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={sp}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={sp - tol} MAXIMUM={sp + tol}
    {% set msgh = "Holding %.0fC for %ds..." % (sp, hold) %}
    RESPOND TYPE=echo MSG="{msgh}"
    G4 P{hold * 1000}
  {% endfor %}

  # Final target
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={target}
  TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={target - tol} MAXIMUM={target + tol}
  {% set msg1 = "BED_STEP_RAMP: Reached %.0fC." % (target,) %}
  RESPOND TYPE=echo MSG="{msg1}"


[gcode_macro PID_TUNE_SAFE_BED]
description: Gentle PID for bed: step-ramp to (TARGET-DELTA), then PID_CALIBRATE at TARGET. Optional autosave.
variable_default_delta: 2
gcode:
  {% set target   = params.TARGET|default(110)|float %}
  {% set delta    = params.DELTA|default(default_delta)|float %}
  {% set save_cfg = params.SAVE|default(0)|int %}
  {% set step     = params.STEP|default(none) %}
  {% set hold_s   = params.HOLD_S|default(none) %}
  {% set tol      = params.TOL|default(none) %}

  {% if target < 1.0 %}{% set target = 1.0 %}{% endif %}
  {% if delta  < 0.0 %}{% set delta  = 0.0 %}{% endif %}

  {% set preheat = target - delta %}
  {% if preheat < 1.0 %}{% set preheat = 1.0 %}{% endif %}

  {% set msg1 = "PID_TUNE_SAFE_BED: Preheating to %.0fC (step ramp), then PID at %.0fC." % (preheat, target) %}
  RESPOND TYPE=echo MSG="{msg1}"

  {% if step is not none and hold_s is not none and tol is not none %}
    BED_STEP_RAMP TARGET={preheat} STEP={step} HOLD_S={hold_s} TOL={tol}
  {% elif step is not none and hold_s is not none %}
    BED_STEP_RAMP TARGET={preheat} STEP={step} HOLD_S={hold_s}
  {% elif step is not none %}
    BED_STEP_RAMP TARGET={preheat} STEP={step}
  {% else %}
    BED_STEP_RAMP TARGET={preheat}
  {% endif %}

  {% set msg2 = "PID_TUNE_SAFE_BED: Starting PID_CALIBRATE at %.0fC." % (target,) %}
  RESPOND TYPE=echo MSG="{msg2}"
  PID_CALIBRATE HEATER=heater_bed TARGET={target}

  {% if save_cfg == 1 %}
    RESPOND TYPE=echo MSG="PID_TUNE_SAFE_BED: SAVE_CONFIG"
    SAVE_CONFIG
  {% endif %}

  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={target}
  TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={target-1} MAXIMUM={target+1}
  RESPOND TYPE=echo MSG="PID_TUNE_SAFE_BED: Complete."

[gcode_macro BED_60]
description: Step-ramp bed to 60°C (10°C steps, 70s holds)
gcode:
  BED_STEP_RAMP TARGET=60 STEP=10 HOLD_S=70

[gcode_macro BED_70]
description: Step-ramp bed to 70°C (10°C steps, 70s holds)
gcode:
  BED_STEP_RAMP TARGET=70 STEP=10 HOLD_S=70

[gcode_macro BED_100]
description: Step-ramp bed to 100°C (10°C steps, 70s holds)
gcode:
  BED_STEP_RAMP TARGET=100 STEP=10 HOLD_S=70

# --- The following sections were commented out in your original file ---
# --- They are kept commented here as requested for minimal changes ---

#[virtual_sdcard]
##[display_status]
#[pause_resume]

# --- Eddy Homing Macros (Commented Out) ---
# Uncomment these if you want to use the Eddy probe for Z homing.
# You will also need to ensure the Z-Offset Beta macros below are uncommented.

#[save_variables]
#filename: ~/printer_data/config/variables.cfg

#[force_move]
#enable_force_move: True # Allows a user to move the z axis down if they have no other means of homing Z and need to calibrate the Eddy.

#[delayed_gcode RESTORE_PROBE_OFFSET]
#initial_duration: 1.
#gcode:
#  {% set svv = printer.save_variables.variables %}
#  {% if not printer["gcode_macro SET_GCODE_OFFSET"].restored %}
#    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ svv.nvm_offset|default(0) }
#    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=restored VALUE=True
#  {% endif %}

#[gcode_macro G28]
#rename_existing: G28.1
#gcode:
#  #SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=True # Uncomment this if using a KNOMI and then remove the G28 macro from the KNOMI.cfg
#  G28.1 {rawparams}
#  {% if not rawparams or (rawparams and 'Z' in rawparams) %}
#    PROBE
#    SET_Z_FROM_PROBE
#  {% endif %}
#  #SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=homing VALUE=False # Uncomment this if using a KNOMI and then remove the G28 macro from the KNOMI.cfg

#[gcode_macro SET_Z_FROM_PROBE]
#gcode:
#    {% set cf = printer.configfile.settings %}
#    SET_GCODE_OFFSET_ORIG Z={printer.probe.last_z_result - cf['probe_eddy_current btt_eddy'].z_offset + printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset}
#    G90
#    G1 Z{cf.safe_z_home.z_hop}

# --- Eddy Z-Offset Beta Macros (Commented Out) ---
# Uncomment these if using Eddy for homing AND you want live Z-offset saving.

#[gcode_macro Z_OFFSET_APPLY_PROBE]
#rename_existing: Z_OFFSET_APPLY_PROBE_ORIG
#gcode:
#  SAVE_VARIABLE VARIABLE=nvm_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset }

#[gcode_macro SET_GCODE_OFFSET]
#rename_existing: SET_GCODE_OFFSET_ORIG
#variable_restored: False  # Mark whether the var has been restored from NVM
#variable_runtime_offset: 0
#gcode:
#  {% if params.Z_ADJUST %}
#    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE={ printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset + params.Z_ADJUST|float }
#  {% endif %}
#  {% if params.Z %}
#    {% set paramList = rawparams.split() %}
#    {% for i in range(paramList|length) %}
#      {% if paramList[i]=="Z=0" %}
#        {% set temp=paramList.pop(i) %}
#        {% set temp="Z_ADJUST=" + (-printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset)|string %}
#        {% if paramList.append(temp) %}{% endif %}
#      {% endif %}
#    {% endfor %}
#    {% set rawparams=paramList|join(' ') %}
#    SET_GCODE_VARIABLE MACRO=SET_GCODE_OFFSET VARIABLE=runtime_offset VALUE=0
#  {% endif %}
#  SET_GCODE_OFFSET_ORIG { rawparams }

#[gcode_macro PROBE_EDDY_CURRENT_CALIBRATE_AUTO]
#gcode:
#  BED_MESH_CLEAR
#  G28
#  G90
#  G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F6000
#  PROBE
#  SET_Z_FROM_PROBE
#  PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy

#[gcode_macro BED_MESH_CALIBRATE]
#rename_existing: BTT_BED_MESH_CALIBRATE
#gcode:
#  #SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=True #Only uncomment this line if using a KNOMI and then remove the BED_MESH_CALIBRATE macro from KNOMI.cfg
#  BTT_BED_MESH_CALIBRATE METHOD=rapid_scan
#  #SET_GCODE_VARIABLE MACRO=_KNOMI_STATUS VARIABLE=probing VALUE=False #Only uncomment this line if using a KNOMI and then remove the BED_MESH_CALIBRATE macro from KNOMI.cfg

