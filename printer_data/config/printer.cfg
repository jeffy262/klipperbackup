# ================== INCLUDED CONFIG FILES ==================
[include mainsail.cfg]
[include led_effects.cfg]
[include screws_tilt_adjust.cfg]
[include moonraker_obico_macros.cfg]
[include wipe_nozzle_pause.cfg]
[include macros.cfg]
[include sample-bigtreetech-adxl345-v2.0.cfg]
[include knomi.cfg]
[include bigtreetech-eddy-zoffbeta.cfg]
[include sample-bigtreetech-ebb-sb-usb-v1.0.cfg]
[include ebbfan.cfg]
[include skr3fan.cfg]
[include WIPE_NOZZLE.cfg]
[exclude_object]

# ================== TEMPERATURE SENSORS ==================
[temperature_sensor CB2_CPU]
sensor_type: temperature_host
min_temp: 0
max_temp: 90

[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PA3
pullup_resistor: 4700
min_temp: -20
max_temp: 120

# ================== MCU DEFINITIONS ==================
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_070026001351333031373138-if00

# ================== PRINTER ==================
[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 2000
max_z_velocity: 40
max_z_accel: 160
square_corner_velocity: 7

# ================== STEPPERS ==================
[stepper_x]
step_pin: PD4
dir_pin: !PD3
enable_pin: !PD6
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: -2
position_endstop: 0
position_max: 430
homing_speed: 50
homing_retract_dist: 0
homing_positive_dir: false

[tmc2209 stepper_x]
uart_pin: PD5
diag_pin: ^PC1
driver_SGTHRS: 90
run_current: 0.8
hold_current: 0.6
sense_resistor: 0.220
interpolate: True
stealthchop_threshold: 0

[stepper_y]
step_pin: PA15
dir_pin: !PA8
enable_pin: !PD1
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: -2
position_endstop: 0
position_max: 435
homing_speed: 50
homing_retract_dist: 0
homing_positive_dir: false

[tmc2209 stepper_y]
uart_pin: PD0
diag_pin: ^PC3
driver_SGTHRS: 80
run_current: 0.6
hold_current: 0.35
sense_resistor: 0.220
interpolate: True
stealthchop_threshold: 0

[stepper_z]
step_pin: PE2
dir_pin: PE3
enable_pin: !PE0
microsteps: 16
rotation_distance: 8
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_min: -5
position_max: 395
homing_speed: 5
second_homing_speed: 3
homing_retract_dist: 7

[tmc2209 stepper_z]
uart_pin: PE1
run_current: 0.85
hold_current: 0.5
sense_resistor: 0.220
interpolate: True
stealthchop_threshold: 0

# ================== FILAMENT SENSOR ==================
[filament_switch_sensor filament_sensor]
switch_pin: ^PC15
pause_on_runout: True
insert_gcode:
    M117 Insert Detected

# ================== HEATERS & FANS ==================
[heater_bed]
heater_pin: PD7
sensor_type: Generic 3950
sensor_pin: PA1
control: pid
pid_Kp: 62.465
pid_Ki: 1.482
pid_Kd: 658.225
min_temp: 10
max_temp: 115


[controller_fan motherboard_fan]
pin: PB7
stepper: stepper_x, stepper_y, stepper_z, extruder
heater: heater_bed
idle_timeout: 60

# ================== INPUT SHAPER ==================
[input_shaper]
shaper_type_x: mzv
shaper_freq_x: 38.4
shaper_type_y: ei
shaper_freq_y: 33.0

# ================== BED HEAT MACROS ==================
[gcode_macro BED_STEP_RAMP]
description: Ramp bed to TARGET in fixed steps (default 10C) and hold at each step (default 70s).
variable_step_c: 10
variable_hold_s: 70
variable_tol_c: 1.0
gcode:
  {% set target = params.TARGET|default(110)|float %}
  {% set step   = params.STEP|default(step_c)|int %}
  {% set hold   = params.HOLD_S|default(hold_s)|int %}
  {% set tol    = params.TOL|default(tol_c)|float %}
  {% set start = printer.heater_bed.temperature|float %}
  {% set first_stop = ((start / step)|int * step) + step %}
  {% if first_stop > target %}{% set first_stop = target %}{% endif %}
  RESPOND TYPE=echo MSG={"BED_STEP_RAMP: %.1f->%.0fC, step=%dC, hold=%ds" % (start, target, step, hold)}
  {% for sp in range(first_stop|int, (target|int), step) %}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={sp}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={sp - tol} MAXIMUM={sp + tol}
    RESPOND TYPE=echo MSG={"Holding %.0fC for %ds..." % (sp, hold)}
    G4 P{hold * 1000}
  {% endfor %}
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={target}
  TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={target - tol} MAXIMUM={target + tol}
  RESPOND TYPE=echo MSG={"BED_STEP_RAMP: Reached %.0fC." % (target,)}

[gcode_macro BED_60]
gcode: BED_STEP_RAMP TARGET=60 STEP=10 HOLD_S=70

[gcode_macro BED_70]
gcode: BED_STEP_RAMP TARGET=70 STEP=10 HOLD_S=70

[gcode_macro BED_100]
gcode: BED_STEP_RAMP TARGET=100 STEP=10 HOLD_S=70

# ================== BOARD PINS ==================
[board_pins]
aliases:
    EXP1_1=PC5, EXP1_3=PB1, EXP1_5=PE9,  EXP1_7=PE11, EXP1_9=<GND>,
    EXP1_2=PB0, EXP1_4=PE8, EXP1_6=PE10, EXP1_8=PE12, EXP1_10=<5V>,
    EXP2_1=PA6, EXP2_3=PE7, EXP2_5=PB2, EXP2_7=PC4,   EXP2_9=<GND>,
    EXP2_2=PA5, EXP2_4=PA4, EXP2_6=PA7, EXP2_8=<RST>, EXP2_10=<NC>

# ================== AUTO-GENERATED (Klipper managed) ==================
#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT BELOW THIS LINE

# (leave this block to be managed by Klipper)


# See the sample-lcd.cfg file for definitions of common LCD displays.

########################################
# TMC2209 configuration
########################################







#[tmc2209 extruder]
#uart_pin: PC6
#run_current: 0.600
#diag_pin:

#[tmc2209 extruder1]
#uart_pin: PD12
#run_current: 0.600
#diag_pin:

########################################
# TMC2130 configuration
########################################

#[tmc2130 stepper_x]
#cs_pin: PD5
#spi_software_miso_pin: PE15
#spi_software_mosi_pin: PE13
#spi_software_sclk_pin: PE14
#run_current: 0.800
#stealthchop_threshold: 999999
#diag1_pin: PC1

#[tmc2130 stepper_y]
#cs_pin: PD0
#spi_software_miso_pin: PE15
#spi_software_mosi_pin: PE13
#spi_software_sclk_pin: PE14
#run_current: 0.800
#stealthchop_threshold: 999999
#diag1_pin: PC3

#[tmc2130 stepper_z]
#cs_pin: PE1
#spi_software_miso_pin: PE15
#spi_software_mosi_pin: PE13
#spi_software_sclk_pin: PE14
#run_current: 0.650
#stealthchop_threshold: 999999
#diag1_pin: PC0

#[tmc2130 extruder]
#cs_pin: PC6
#spi_software_miso_pin: PE15
#spi_software_mosi_pin: PE13
#spi_software_sclk_pin: PE14
#run_current: 0.800
#stealthchop_threshold: 999999
#diag1_pin: PC2

#[tmc2130 extruder1]
#cs_pin: PD12
#spi_software_miso_pin: PE15
#spi_software_mosi_pin: PE13
#spi_software_sclk_pin: PE14
#run_current: 0.800
#stealthchop_threshold: 999999
#diag1_pin: PA0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# z_offset = 2.781
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3240098.703,0.090000:3239439.087,0.130000:3238728.568,
#*# 	0.170000:3238071.887,0.210000:3237331.043,0.250000:3236587.947,
#*# 	0.290000:3235819.888,0.330000:3235096.414,0.370000:3234339.566,
#*# 	0.410000:3233596.873,0.450000:3232874.331,0.490000:3232189.606,
#*# 	0.530000:3231480.135,0.570000:3230820.099,0.610000:3230163.415,
#*# 	0.650000:3229523.724,0.690000:3228876.272,0.730000:3228275.150,
#*# 	0.770000:3227637.958,0.810000:3227062.274,0.850000:3226463.387,
#*# 	0.890000:3225868.034,0.930000:3225300.561,0.970000:3224787.699,
#*# 	1.010000:3224240.327,1.050000:3223727.462,1.090000:3223194.705,
#*# 	1.130000:3222691.262,1.170000:3222200.208,1.210000:3221709.234,
#*# 	1.250000:3221208.506,1.290000:3220755.638,1.330000:3220276.231,
#*# 	1.370000:3219831.206,1.410000:3219382.671,1.450000:3218952.865,
#*# 	1.490000:3218542.571,1.530000:3218120.007,1.570000:3217710.037,
#*# 	1.610000:3217312.006,1.650000:3216902.795,1.690000:3216517.166,
#*# 	1.730000:3216137.948,1.770000:3215774.324,1.810000:3215403.058,
#*# 	1.850000:3215052.934,1.890000:3214707.486,1.930000:3214366.554,
#*# 	1.970000:3214022.981,2.010000:3213676.585,2.050000:3213344.895,
#*# 	2.090000:3213020.212,2.130000:3212710.907,2.170000:3212373.532,
#*# 	2.210000:3212084.035,2.250000:3211779.216,2.290000:3211501.876,
#*# 	2.330000:3211200.658,2.370000:3210886.570,2.410000:3210620.096,
#*# 	2.450000:3210328.305,2.490000:3210067.847,2.530000:3209794.391,
#*# 	2.570000:3209544.786,2.610000:3209303.230,2.650000:3209043.301,
#*# 	2.690000:3208796.255,2.730000:3208560.483,2.770000:3208294.760,
#*# 	2.810000:3208053.891,2.850000:3207835.134,2.890000:3207600.104,
#*# 	2.930000:3207398.169,2.970000:3207153.738,3.010000:3206930.041,
#*# 	3.050000:3206737.301,3.090000:3206508.445,3.130000:3206302.802,
#*# 	3.170000:3206123.894,3.210000:3205910.012,3.250000:3205733.303,
#*# 	3.290000:3205539.749,3.330000:3205349.520,3.370000:3205158.528,
#*# 	3.410000:3204982.372,3.450000:3204817.435,3.490000:3204627.851,
#*# 	3.530000:3204494.925,3.570000:3204304.310,3.610000:3204117.365,
#*# 	3.650000:3203974.312,3.690000:3203803.096,3.730000:3203618.748,
#*# 	3.770000:3203466.715,3.810000:3203289.955,3.850000:3203148.909,
#*# 	3.890000:3202978.499,3.930000:3202834.990,3.970000:3202698.187,
#*# 	4.010000:3202546.617,4.050000:3202410.799
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 44.699968
#*# drift_calibration =
#*# 	3274238.528382, -1050.979270, 9.719414
#*# 	3250513.025280, -451.839830, 3.800633
#*# 	3238539.712094, -318.721378, 2.615138
#*# 	3229404.470212, -233.890181, 1.753721
#*# 	3220500.820526, -98.066528, 0.423859
#*# 	3213820.260864, -1.221144, -0.511388
#*# 	3209302.907959, 43.301258, -0.921270
#*# 	3205573.811628, 80.046592, -1.267420
#*# 	3201702.289020, 140.510842, -1.837133
#*# drift_calibration_min_temp = 33.55159907837751
#*#
#*# [input_shaper]
#*#
#*# [heater_bed]
#*# pid_kp = 62.465
#*# pid_ki = 1.482
#*# pid_kd = 658.225
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.200123, -0.218205, -0.264081, 0.002715, 0.059187, 0.110825, 0.171465, -0.145347, -0.083750, 0.016415
#*# 	-0.009191, 0.022377, -0.018870, -0.014405, 0.027757, 0.064746, 0.094801, 0.144629, 0.222331, 0.339537
#*# 	-0.069198, -0.015787, -0.056986, -0.064640, -0.040944, -0.019833, 0.002723, 0.031505, 0.087114, 0.121150
#*# 	-0.059897, 0.004573, -0.026524, -0.032530, -0.003360, 0.007992, 0.018087, 0.038048, 0.065813, 0.064613
#*# 	-0.009535, 0.063323, 0.031035, 0.017896, 0.020812, 0.041331, 0.028361, 0.030470, 0.055275, 0.056767
#*# 	0.005806, 0.080730, 0.061391, 0.056341, 0.072947, 0.081408, 0.083686, 0.078545, 0.093029, 0.090803
#*# 	-0.019265, 0.062773, 0.048272, 0.046180, 0.066819, 0.078813, 0.074834, 0.075177, 0.106957, 0.112396
#*# 	-0.014927, 0.070055, 0.067442, 0.075385, 0.149475, 0.139059, 0.139216, 0.145906, 0.164663, 0.155403
#*# 	0.051200, 0.113302, 0.093772, 0.082998, 0.105941, 0.109202, 0.105325, 0.113387, 0.138082, 0.157033
#*# 	0.089861, 0.145589, 0.093227, 0.076946, 0.094429, 0.110245, 0.130239, 0.140683, 0.189768, 0.152736
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 404.96999999999997
#*# min_y = 30.0
#*# max_y = 390.0
#*#
#*# [bed_mesh current]
#*# version = 1
#*# points =
#*# 	0.090515, 0.088414, 0.140734, 0.193101, 0.215161, 0.190194, 0.134279, 0.064757, 0.013123
#*# 	0.129589, 0.160567, 0.226052, 0.286390, 0.303607, 0.257292, 0.198309, 0.140891, 0.082897
#*# 	0.157070, 0.181679, 0.220185, 0.271783, 0.291353, 0.235119, 0.179256, 0.125669, 0.085178
#*# 	0.172770, 0.181152, 0.206885, 0.247730, 0.256899, 0.219300, 0.172322, 0.133652, 0.103787
#*# 	0.112235, 0.105395, 0.096153, 0.103280, 0.100004, 0.091874, 0.076071, 0.085261, 0.096360
#*# 	0.045313, 0.028258, 0.005010, -0.000438, 0.000145, 0.027982, 0.036308, 0.066785, 0.082917
#*# 	0.016240, -0.016477, -0.058345, -0.044920, -0.072816, -0.043931, -0.012675, 0.034868, 0.083391
#*# 	0.053117, -0.003795, -0.042931, -0.055227, -0.043180, -0.020830, -0.001305, 0.040770, 0.076262
#*# 	0.068517, -0.000546, -0.048167, -0.059591, -0.060645, -0.035472, -0.010656, 0.051819, 0.096396
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 61.16759999999999
#*# max_x = 374.0476
#*# min_y = 95.614
#*# max_y = 384.01400000000007
