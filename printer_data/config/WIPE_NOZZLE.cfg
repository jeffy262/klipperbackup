[gcode_macro WIPE_NOZZLE]
description: Heat (if needed) and wipe nozzle on front pad
# Tunables (refer inside macro as names *without* variable_)
variable_min_wipe_temp: 200         # Â°C; set 0 to skip heating
variable_lift_z: 5.0                # mm: safe travel Z
variable_press_z: 0.10              # mm: press into wiper (Z height)
variable_slow_f: 1000               # mm/min: slow wipe strokes
variable_fast_f: 2000               # mm/min: fast wipe strokes / moves
gcode:
  {% if printer.toolhead.homed_axes != "xyz" %}
    RESPOND TYPE=error MSG="WIPE_NOZZLE: axes not homed; skipping."
  {% else %}
    SAVE_GCODE_STATE NAME=WIPE_NOZZLE_STATE
    G90

    ; heat to at least min_wipe_temp (or honor higher current target)
    {% set need = params.MIN_WIPE_TEMP|default(min_wipe_temp)|int %}
    {% if need > 0 %}
      {% set tgt = [need, printer.extruder.target|int]|max %}
      {% if printer.extruder.temperature < tgt %}
        M104 S{tgt}
        M109 S{tgt}
      {% endif %}
    {% endif %}

    M117 Wipe Nozzle...

    ; approach pad
    G1 Z{lift_z} F3000
    G1 X412 Y16.5 F3000     ; move above wiper pad
    G1 Z{press_z} F1500     ; press into wiper (use small positive Z, safer than Z0)

    ; your slow strokes
    G1 X396 Y19   F{slow_f}
    G1 X428 Y14   F{slow_f}
    G1 X396 Y15.5 F{slow_f}
    G1 X428 Y19   F{slow_f}
    G1 X428 Y14   F{slow_f}
    G1 X396 Y16.5 F{slow_f}

    ; faster cleanup passes (fixed the double F on one line)
    G1 X396 Y19   F{fast_f}
    G1 X428 Y14   F{fast_f}
    G1 X428 Y14   F{fast_f}
    G1 X396 Y15.5 F{fast_f}
    G1 X428 Y14   F{fast_f}
    G1 X396 Y16.5 F{fast_f}
    G1 X428 Y16.5 F{fast_f}
    G1 X396 Y17.5 F{fast_f}

    ; retract from pad
    G1 Z20 F3000
    G1 Y26 F3000

    M117 Nozzle Clean...
    RESTORE_GCODE_STATE NAME=WIPE_NOZZLE_STATE
  {% endif %}
