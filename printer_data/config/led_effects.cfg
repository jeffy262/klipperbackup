# -------------------- LED Effects --------------------
[led_effect bed_leds]
autostart: False
frame_rate: 24
heater: heater_bed
leds: neopixel:under_lights (54-125)
layers:
    temperaturegauge 20 70 top (0.25,0.00,0.00),(0.19,0.00,0.00),(0.14,0.00,0.00),(0.20,0.15,0.00),(0.20,0.215,0.00),(0.00,0.00,0.10),(0.00,0.00,0.10),(0.00,0.00,0.10)


[led_effect hotend_leds]
autostart: False
frame_rate: 24
heater: extruder
leds: neopixel:my_neopixel (59-131)
layers:
    temperaturegauge 22 235 top (0.25,0.00,0.00),(0.19,0.00,0.00),(0.14,0.00,0.00),(0.20,0.15,0.00),(0.20,0.215,0.00),(0.00,0.00,0.10),(0.00,0.00,0.10),(0.00,0.00,0.10)



[led_effect rainbow_leds]
autostart: False
frame_rate: 24
leds: neopixel:under_lights (1-53)
layers:
    # Original: (0.3,0.0,0.0),(0.0,0.3,0.0),(0.0,0.0,0.3)
    # 65%:      (0.195,0.0,0.0),(0.0,0.195,0.0),(0.0,0.0,0.195)
    gradient 0.3 1 add (0.195,0.0,0.0),(0.0,0.195,0.0),(0.0,0.0,0.195)

[led_effect under_standby_leds]
autostart: False
frame_rate: 24
leds: neopixel:under_lights (1-53)
layers:
    # Original: (0,0,1),(1,0,0)
    # 65%:      (0,0,0.65),(0.65,0,0)
    linearfade 20 0 top (0,0,0.65),(0.65,0,0)

[led_effect set_nozzle_leds]
autostart: False
frame_rate: 24
leds:
    neopixel:sb_leds (2,3)
layers:
    static 0 0 top (0.0,0.0,0.0,0.6)


# -------------------- Neopixel buses --------------------

[neopixel my_neopixel]
pin: PE6
chain_count: 132
color_order: GRB
initial_RED: 0.7
initial_GREEN: 0.7
initial_BLUE: 0.7
initial_WHITE: 0.0

[neopixel under_lights]
pin: PC5
chain_count: 125
color_order: GRB
initial_RED: 0.0
initial_GREEN: 0.0
initial_BLUE: 1.0
initial_WHITE: 0.0

[neopixel sb_leds]
pin: EBB:gpio15
chain_count: 3
color_order: GRBW
initial_RED: 1.0
initial_GREEN: 0.0
initial_BLUE: 0.0
initial_WHITE: 0.0

# -------------------- Safe startup of effects --------------------

[delayed_gcode _START_LED_EFFECTS]
initial_duration: 2.5
gcode:
    # Start only after all MCUs (including EBB) are connected.
    SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1
    SET_LED_EFFECT EFFECT=bed_leds
    SET_LED_EFFECT EFFECT=hotend_leds
    SET_LED_EFFECT EFFECT=set_nozzle_leds

# -------------------- Convenience macros (optional) --------------------

[gcode_macro HOTEND_LEDS]
gcode:
    SET_LED_EFFECT EFFECT=hotend_leds

[gcode_macro RAINBOW_LEDS]
gcode:
    SET_LED_EFFECT EFFECT=rainbow_leds REPLACE=1

[gcode_macro RAINBOW_LEDS_OFF]
gcode:
    SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1

# -------------------- Error LED effect (no virtual_sdcard needed) --------------------
[led_effect sb_critical_error]
autostart: False
frame_rate: 24
leds: neopixel:sb_leds (1-3)   # adjust range if your SB has different count
run_on_error: True             # auto-fire if Klipper enters error/shutdown
layers:
    strobe      1  1.5  add        (1.0, 1.0, 1.0)
    breathing   2  0    difference (0.95, 0.0, 0.0)
    static      1  0    top        (1.0, 0.0, 0.0)

[gcode_macro _TRIP_ERROR_LEDS]
gcode:
    STOP_LED_EFFECTS
    SET_LED_EFFECT EFFECT=sb_critical_error REPLACE=1

[gcode_macro CLEAR_ERROR_LEDS]
description: Clear SB error LEDs and restore standby lighting
gcode:
  ; Stop only StealthBurner LEDs (leave under_lights / my_neopixel alone)
  STOP_LED_EFFECTS LEDS=neopixel:sb_leds

  ; Clear any solid red set via fallback
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=1 TRANSMIT=0
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=2 TRANSMIT=0
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=3 TRANSMIT=1

  ; Reapply your normal standby effects
  SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1
  SET_LED_EFFECT EFFECT=set_nozzle_leds REPLACE=1
  SET_LED_EFFECT EFFECT=bed_leds
  SET_LED_EFFECT EFFECT=hotend_leds



[gcode_macro _ON_ERROR_LEDS]
gcode:
  {% if printer.configfile.config.get('led_effect sb_critical_error') is not none %}
    STOP_LED_EFFECTS LEDS=neopixel:sb_leds
    SET_LED_EFFECT EFFECT=sb_critical_error REPLACE=1
  {% else %}
    ; Fallback: turn the SB LEDs solid red if the effect isnâ€™t defined
    SET_LED LED=sb_leds RED=1 GREEN=0 BLUE=0 WHITE=0 INDEX=1 TRANSMIT=0
    SET_LED LED=sb_leds RED=1 GREEN=0 BLUE=0 WHITE=0 INDEX=2 TRANSMIT=0
    SET_LED LED=sb_leds RED=1 GREEN=0 BLUE=0 WHITE=0 INDEX=3 TRANSMIT=1
  {% endif %}


 #######################################################################   
