# -------------------- LED Effects --------------------
[led_effect bed_leds]
autostart: False
frame_rate: 24
heater: heater_bed
leds: neopixel:under_lights (54-125)
layers:
    temperaturegauge 20 70 top (0.25,0.00,0.00),(0.19,0.00,0.00),(0.14,0.00,0.00),(0.20,0.15,0.00),(0.20,0.215,0.00),(0.00,0.00,0.10),(0.00,0.00,0.10),(0.00,0.00,0.10)


[led_effect hotend_leds]
autostart: False
frame_rate: 24
heater: extruder
leds: neopixel:my_neopixel (59-131)
layers:
    temperaturegauge 22 235 top (0.25,0.00,0.00),(0.19,0.00,0.00),(0.14,0.00,0.00),(0.20,0.15,0.00),(0.20,0.215,0.00),(0.00,0.00,0.10),(0.00,0.00,0.10),(0.00,0.00,0.10)



[led_effect rainbow_leds]
autostart: False
frame_rate: 24
leds: neopixel:under_lights (1-53)
layers:
    # Original: (0.3,0.0,0.0),(0.0,0.3,0.0),(0.0,0.0,0.3)
    # 65%:      (0.195,0.0,0.0),(0.0,0.195,0.0),(0.0,0.0,0.195)
    gradient 0.3 1 add (0.195,0.0,0.0),(0.0,0.195,0.0),(0.0,0.0,0.195)

[led_effect under_standby_leds]
autostart: False
frame_rate: 24
leds: neopixel:under_lights (1-53)
layers:
    # Original: (0,0,1),(1,0,0)
    # 65%:      (0,0,0.65),(0.65,0,0)
    linearfade 20 0 top (0,0,0.65),(0.65,0,0)

[led_effect set_nozzle_leds]
autostart: False
frame_rate: 24
leds:
    neopixel:sb_leds (2,3)
layers:
    static 0 0 top (0.0,0.0,0.0,0.6)

# -------------------- Neopixel buses --------------------

[neopixel my_neopixel]
pin: PE6
chain_count: 132
color_order: GRB
initial_RED: 0.7
initial_GREEN: 0.7
initial_BLUE: 0.7
initial_WHITE: 0.0

[neopixel under_lights]
pin: PE5
chain_count: 125
color_order: GRB
initial_RED: 0.0
initial_GREEN: 0.0
initial_BLUE: 1.0
initial_WHITE: 0.0

[neopixel sb_leds]
pin: EBB:gpio15
chain_count: 3
color_order: GRBW
initial_RED: 1.0
initial_GREEN: 0.0
initial_BLUE: 0.0
initial_WHITE: 0.0

# -------------------- Safe startup of effects --------------------

[delayed_gcode _START_LED_EFFECTS]
initial_duration: 2.5
gcode:
    # Start only after all MCUs (including EBB) are connected.
    SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1
    SET_LED_EFFECT EFFECT=bed_leds
    SET_LED_EFFECT EFFECT=hotend_leds
    SET_LED_EFFECT EFFECT=set_nozzle_leds

# -------------------- Convenience macros (optional) --------------------

[gcode_macro HOTEND_LEDS]
gcode:
    SET_LED_EFFECT EFFECT=hotend_leds

[gcode_macro RAINBOW_LEDS]
gcode:
    SET_LED_EFFECT EFFECT=rainbow_leds REPLACE=1

[gcode_macro RAINBOW_LEDS_OFF]
gcode:
    SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1

 #######################################################################   
[gcode_macro LED_STATUS]
description: Orchestrate SB leds + under_lights + bed/hotend effects
# Usage examples:
#   LED_STATUS MODE=ready
#   LED_STATUS MODE=heating
#   LED_STATUS MODE=printing
#   LED_STATUS MODE=part_ready
#   LED_STATUS MODE=off
gcode:
  {% set mode = (params.MODE|default("ready"))|lower %}

  # Presence checks so we only call what exists
  {% set has = printer.configfile.config.get %}
  {% set have_sb_ready      = has('gcode_macro status_ready') is not none %}
  {% set have_sb_heating    = has('gcode_macro status_heating') is not none %}
  {% set have_sb_cooling    = has('gcode_macro status_cooling') is not none %}
  {% set have_sb_homing     = has('gcode_macro status_homing') is not none %}
  {% set have_sb_leveling   = has('gcode_macro status_leveling') is not none %}
  {% set have_sb_meshing    = has('gcode_macro status_meshing') is not none %}
  {% set have_sb_cleaning   = has('gcode_macro status_cleaning') is not none %}
  {% set have_sb_zcal       = has('gcode_macro status_calibrating_z') is not none %}
  {% set have_sb_printing   = has('gcode_macro status_printing') is not none %}
  {% set have_sb_partready  = has('gcode_macro status_part_ready') is not none %}

  {% set have_under_rainbow_macro = has('gcode_macro RAINBOW_LEDS') is not none %}
  {% set have_under_rainbow_eff   = has('led_effect rainbow_leds') is not none %}
  {% set have_under_standby_eff   = has('led_effect under_standby_leds') is not none %}

  {% set have_bed_eff      = has('led_effect bed_leds') is not none %}
  {% set have_hotend_macro = has('gcode_macro HOTEND_LEDS') is not none %}
  {% set have_hotend_eff   = has('led_effect hotend_leds') is not none %}
  {% set have_nozzle_set   = has('led_effect set_nozzle_leds') is not none %}

  {% set have_sb_rainbow_eff = has('led_effect rainbow') is not none %}
  {% set have_under_off_macro = has('gcode_macro RAINBOW_LEDS_OFF') is not none %}

  {% if mode in ['off','disable','stop'] %}
    STOP_LED_EFFECTS

  {% elif mode in ['ready','standby'] %}
    {% if have_sb_ready %} status_ready
    {% elif have_sb_rainbow_eff %} SET_LED_EFFECT EFFECT=rainbow
    {% endif %}
    {% if have_under_standby_eff %} SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1 {% endif %}
    {% if have_bed_eff %} SET_LED_EFFECT EFFECT=bed_leds {% endif %}
    {% if have_hotend_macro %} HOTEND_LEDS
    {% elif have_hotend_eff %} SET_LED_EFFECT EFFECT=hotend_leds
    {% endif %}
    {% if have_nozzle_set %} SET_LED_EFFECT EFFECT=set_nozzle_leds {% endif %}

  {% elif mode == 'heating' %}
    {% if have_sb_heating %} status_heating {% endif %}
    {% if have_under_standby_eff %} SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1 {% endif %}
    {% if have_bed_eff %} SET_LED_EFFECT EFFECT=bed_leds {% endif %}
    {% if have_hotend_macro %} HOTEND_LEDS
    {% elif have_hotend_eff %} SET_LED_EFFECT EFFECT=hotend_leds
    {% endif %}
    {% if have_nozzle_set %} SET_LED_EFFECT EFFECT=set_nozzle_leds {% endif %}

  {% elif mode == 'cooling' %}
    {% if have_sb_cooling %} status_cooling {% endif %}
    {% if have_under_standby_eff %} SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1 {% endif %}
    {% if have_bed_eff %} SET_LED_EFFECT EFFECT=bed_leds {% endif %}
    {% if have_hotend_macro %} HOTEND_LEDS
    {% elif have_hotend_eff %} SET_LED_EFFECT EFFECT=hotend_leds
    {% endif %}
    {% if have_nozzle_set %} SET_LED_EFFECT EFFECT=set_nozzle_leds {% endif %}

  {% elif mode == 'homing' %}
    {% if have_sb_homing %} status_homing {% endif %}
    {% if have_under_standby_eff %} SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1 {% endif %}
    {% if have_bed_eff %} SET_LED_EFFECT EFFECT=bed_leds {% endif %}
    {% if have_hotend_macro %} HOTEND_LEDS
    {% elif have_hotend_eff %} SET_LED_EFFECT EFFECT=hotend_leds
    {% endif %}
    {% if have_nozzle_set %} SET_LED_EFFECT EFFECT=set_nozzle_leds {% endif %}

  {% elif mode in ['leveling','qgl'] %}
    {% if have_sb_leveling %} status_leveling {% endif %}
    {% if have_under_standby_eff %} SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1 {% endif %}
    {% if have_bed_eff %} SET_LED_EFFECT EFFECT=bed_leds {% endif %}
    {% if have_hotend_macro %} HOTEND_LEDS
    {% elif have_hotend_eff %} SET_LED_EFFECT EFFECT=hotend_leds
    {% endif %}
    {% if have_nozzle_set %} SET_LED_EFFECT EFFECT=set_nozzle_leds {% endif %}

  {% elif mode in ['meshing','bed_mesh'] %}
    {% if have_sb_meshing %} status_meshing {% endif %}
    {% if have_under_standby_eff %} SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1 {% endif %}
    {% if have_bed_eff %} SET_LED_EFFECT EFFECT=bed_leds {% endif %}
    {% if have_hotend_macro %} HOTEND_LEDS
    {% elif have_hotend_eff %} SET_LED_EFFECT EFFECT=hotend_leds
    {% endif %}
    {% if have_nozzle_set %} SET_LED_EFFECT EFFECT=set_nozzle_leds {% endif %}

  {% elif mode in ['cleaning','wipe'] %}
    {% if have_sb_cleaning %} status_cleaning {% endif %}
    {% if have_under_standby_eff %} SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1 {% endif %}
    {% if have_bed_eff %} SET_LED_EFFECT EFFECT=bed_leds {% endif %}
    {% if have_hotend_macro %} HOTEND_LEDS
    {% elif have_hotend_eff %} SET_LED_EFFECT EFFECT=hotend_leds
    {% endif %}
    {% if have_nozzle_set %} SET_LED_EFFECT EFFECT=set_nozzle_leds {% endif %}

  {% elif mode in ['calibrating_z','z_cal'] %}
    {% if have_sb_zcal %} status_calibrating_z {% endif %}
    {% if have_under_standby_eff %} SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1 {% endif %}
    {% if have_bed_eff %} SET_LED_EFFECT EFFECT=bed_leds {% endif %}
    {% if have_hotend_macro %} HOTEND_LEDS
    {% elif have_hotend_eff %} SET_LED_EFFECT EFFECT=hotend_leds
    {% endif %}
    {% if have_nozzle_set %} SET_LED_EFFECT EFFECT=set_nozzle_leds {% endif %}

  {% elif mode in ['printing','print'] %}
    {% if have_sb_printing %} status_printing {% endif %}
    {% if have_under_rainbow_macro %}
      RAINBOW_LEDS
    {% elif have_under_rainbow_eff %}
      SET_LED_EFFECT EFFECT=rainbow_leds REPLACE=1
    {% endif %}
    {% if have_bed_eff %} SET_LED_EFFECT EFFECT=bed_leds {% endif %}
    {% if have_hotend_macro %} HOTEND_LEDS
    {% elif have_hotend_eff %} SET_LED_EFFECT EFFECT=hotend_leds
    {% endif %}
    {% if have_nozzle_set %} SET_LED_EFFECT EFFECT=set_nozzle_leds {% endif %}

  {% elif mode in ['part_ready','done','complete'] %}
    {% if have_sb_partready %} status_part_ready {% endif %}
    {% if have_under_off_macro %}
      RAINBOW_LEDS_OFF
    {% elif have_under_standby_eff %}
      SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1
    {% endif %}
    {% if have_bed_eff %} SET_LED_EFFECT EFFECT=bed_leds {% endif %}
    {% if have_hotend_macro %} HOTEND_LEDS
    {% elif have_hotend_eff %} SET_LED_EFFECT EFFECT=hotend_leds
    {% endif %}
    {% if have_nozzle_set %} SET_LED_EFFECT EFFECT=set_nozzle_leds {% endif %}

  {% else %}
    ; Fallback â†’ ready
    {% if have_sb_ready %} status_ready {% endif %}
    {% if have_under_standby_eff %} SET_LED_EFFECT EFFECT=under_standby_leds REPLACE=1 {% endif %}
    {% if have_bed_eff %} SET_LED_EFFECT EFFECT=bed_leds {% endif %}
    {% if have_hotend_macro %} HOTEND_LEDS
    {% elif have_hotend_eff %} SET_LED_EFFECT EFFECT=hotend_leds
    {% endif %}
    {% if have_nozzle_set %} SET_LED_EFFECT EFFECT=set_nozzle_leds {% endif %}
  {% endif %}

