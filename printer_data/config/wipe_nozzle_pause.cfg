[gcode_macro WIPE_NOZZLE_PAUSE]
description: Heat (if needed) and wipe nozzle on the front pad after a pause
# ---- tunable defaults (access as the names without 'variable_') ----
variable_min_wipe_temp: 150          # Â°C: only wipe if hotend >= this (heats up to this if cooler)
variable_lift_z: 5.0                 # mm: safe Z lift before moving
variable_press_z: 0.10               # mm: how far to press into the pad
variable_passes: 6                   # number of slow wipe strokes
variable_slow_f: 1200                # mm/min: wipe speed
variable_fast_f: 3000                # mm/min: rapid between strokes
# pad geometry near front-right (adjust to your pad)
variable_x_lo: 396.0
variable_x_hi: 428.0
variable_y_lo: 14.0
variable_y_hi: 19.0
gcode:
  {% if printer.toolhead.homed_axes != "xyz" %}
    RESPOND TYPE=error MSG="WIPE_NOZZLE_PAUSE: axes not homed; skipping."
  {% else %}
    SAVE_GCODE_STATE NAME=WIPE_NOZZLE_PAUSE_STATE
    G90                                   ; absolute XY Z

    ; ---- Temperature guard (use param override if given) ----
    {% set need = params.MIN_WIPE_TEMP|default(min_wipe_temp)|int %}
    {% set cur  = printer.extruder.temperature|float %}
    {% set tgt  = printer.extruder.target|int %}

    {% if cur < need %}
      ; if no higher target is already set, heat to 'need'
      {% if tgt < need %}
        M104 S{need}
        M109 S{need}
      {% else %}
        ; a higher target is already set -> just wait for it
        M109 S{tgt}
      {% endif %}
    {% endif %}

    ; ---- Approach pad safely ----
    G1 Z{lift_z} F3000
    ; go to middle of pad first
    G1 X{(x_lo + x_hi)/2.0} Y{(y_lo + y_hi)/2.0} F{fast_f}
    ; press into pad
    G1 Z{press_z} F1500

    ; ---- Slow wipe strokes between corners ----
    {% for i in range(passes|int) %}
      G1 X{x_lo} Y{y_hi} F{slow_f}
      G1 X{x_hi} Y{y_lo} F{slow_f}
    {% endfor %}

    ; small zig to clean edges at faster speed (optional)
    G1 X{x_lo} Y{y_lo} F{fast_f}
    G1 X{x_hi} Y{y_hi} F{fast_f}

    ; ---- Retract from pad and finish ----
    G1 Z{lift_z} F3000
    RESTORE_GCODE_STATE NAME=WIPE_NOZZLE_PAUSE_STATE
    M117 Nozzle wipe complete
  {% endif %}