# === Real macro (called by START_PRINT / RESUME) ===
[gcode_macro WIPE_NOZZLE_PAUSE]
description: Heat (if needed) and dry-wipe nozzle on pad
# --- Tune these for your pad & machine ---
variable_approach_x: 412.0       # point above pad to approach
variable_approach_y: 16.5
variable_wipe_x1: 396.0          # left edge of wipe path
variable_wipe_x2: 428.0          # right edge of wipe path
variable_wipe_y1: 14.0           # lower Y of wipe band
variable_wipe_y2: 19.0           # upper Y of wipe band
variable_z_travel: 5.0           # safe Z for travels
variable_z_wipe: 0.0             # contact Z on pad (adjust for your pad height)
variable_slow_passes: 4
variable_fast_passes: 6
variable_slow_f: 1000            # mm/min
variable_fast_f: 2000            # mm/min
variable_min_wipe_temp: 190      # heat to at least this if too cold
variable_settle_ms: 120          # brief pause before wiping

gcode:
  {% set target_temp = params.TEMP|default(variable_min_wipe_temp)|int %}

  {% if printer.toolhead.homed_axes != "xyz" %}
    RESPOND TYPE=error MSG="WIPE_NOZZLE_PAUSE: axes not homed; aborting."
  {% elif printer.toolhead.axis_maximum.x < variable_approach_x or printer.toolhead.axis_maximum.y < variable_approach_y %}
    RESPOND TYPE=error MSG="WIPE_NOZZLE_PAUSE: wipe coordinates out of range for this printer."
  {% else %}
    SAVE_GCODE_STATE NAME=WNP_STATE
    M117 Wipe Nozzle...

    G90
    ; Heat if needed
    {% if printer.extruder.temperature < target_temp %}
      M104 S{target_temp}
      M109 S{target_temp}
    {% endif %}

    ; Lift to safe Z (use max of current and z_travel)
    {% set curz = printer.gcode_move.position.z|float %}
    G1 Z{ [curz, z_travel]|max } F3000

    ; Go to approach point over pad
    G1 X{approach_x} Y{approach_y} F6000

    ; Press to wipe Z (gentle)
    G1 Z{z_wipe} F600
    M400
    G4 P{variable_settle_ms}

    ; ---- Slow strokes across the band (alternating) ----
    {% set y_mid1 = wipe_y1 + (wipe_y2 - wipe_y1)*0.30 %}
    {% set y_mid2 = wipe_y1 + (wipe_y2 - wipe_y1)*0.70 %}
    G1 X{wipe_x1} Y{y_mid1} F{variable_slow_f}
    {% for i in range(slow_passes|int) %}
      {% if i % 2 == 0 %}
        G1 X{wipe_x2} Y{y_mid1} F{variable_slow_f}
      {% else %}
        G1 X{wipe_x1} Y{y_mid2} F{variable_slow_f}
      {% endif %}
    {% endfor %}

    ; ---- Fast “dry wipe” passes at a single Y just above the lines ----
    {% set y_wipe = wipe_y1 + (wipe_y2 - wipe_y1)*0.5 %}
    {% for _i in range(fast_passes|int) %}
      G1 X{wipe_x2} Y{y_wipe} F{variable_fast_f}
      G1 X{wipe_x1} Y{y_wipe} F{variable_fast_f}
    {% endfor %}

    ; Exit: lift and park slightly away from pad
    G1 Z{ [z_travel, 10.0]|max } F3000
    G1 Y{approach_y + 9.0} F6000

    M117 Nozzle Clean
    RESTORE_GCODE_STATE NAME=WNP_STATE
  {% endif %}

# === Backward-compat wrapper (lowercase name still works) ===
[gcode_macro wipe_nozzle_pause]
description: Alias to WIPE_NOZZLE_PAUSE
gcode:
  WIPE_NOZZLE_PAUSE {rawparams}
